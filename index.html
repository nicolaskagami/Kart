<html>

<head>
<title>Mairo Kart</title>
//Libraries used
<script src="./src/lib/jquery-1.11.3.js"></script>
<script src="./src/lib/webgl-utils.js"></script>
<script src="./src/lib/webgl-3d-math.js"></script>
<script src="./src/lib/webgl-obj-loader.js"></script>
//Objects
<script src="./src/objects/drawable.js"></script>
<script src="./src/objects/collidable.js"></script>
<script src="./src/objects/movable.js"></script>
<script src="./src/objects/player.js"></script>
//
<script src="./src/camera.js"></script>
<script src="./src/input.js"></script>
<script src="./src/draw.js"></script>

<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
<script id="shader-fs" type="x-shader/x-fragment">
    precision mediump float;

    varying vec2 vTextureCoord;
	varying vec4 vLightResult;
    uniform sampler2D uSampler;

    void main(void) {
		vec4 texelColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));
        gl_FragColor = vec4(texelColor.rgb * vLightResult.rgb, texelColor.a);
    }
</script>
<script id="shader-vs" type="x-shader/x-vertex">
    attribute vec3 a_position;
	attribute vec3 a_normal;
    attribute vec2 a_text_coord;
	
	uniform mat4 u_PMatrix;
	uniform mat4 u_MVMatrix;
	uniform mat4 u_normal_matrix;
	
	uniform float u_shininess;
	uniform vec3 u_light_direction;
	
	uniform vec4 u_ambient_light;
	uniform vec4 u_diffuse_light;
	uniform vec4 u_specular_light;
	
	uniform vec4 u_ambient_material;
	uniform vec4 u_diffuse_material;
	uniform vec4 u_specular_material;
	
	uniform bool u_use_light;
	

    varying vec2 vTextureCoord;
	varying vec4 vLightResult;

    void main(void) {
	
		vec4 vertexWorld = u_MVMatrix * vec4(a_position, 1.0);
		gl_Position = u_PMatrix * u_MVMatrix * vec4(a_position, 1.0);;
		vec3 transformedNormal = vec3(u_normal_matrix * vec4(a_normal, 0.0));
        vTextureCoord = a_text_coord;
		
		//Lighting
		if(u_use_light)
		{
			//vec3 pointLightDirection = normalize((u_MVMatrix * u_light_position) - vertexWorld.xyz);
			//vec3 L = pointLightDirection;
			vec3 vEyeVec = -vec3(vertexWorld.xyz);
			vec3 L = normalize(u_light_direction);
			vec3 N = normalize(transformedNormal);
			
			
			//Lambert's cosine law
			float lambertTerm = max(dot(N,-L),0.0);
			
			//Ambient Term
			vec4 Ia = u_ambient_light * u_ambient_material;
			
			//Diffuse Term
			vec4 Id = vec4(0.0,0.0,0.0,1.0);
		 
			//Specular Term
			vec4 Is = vec4(0.0,0.0,0.0,1.0);
			
			vLightResult = Ia;
			if(lambertTerm > 0.0) {
			    Id = u_diffuse_light * u_diffuse_material * lambertTerm;
				vec3 E = normalize(vEyeVec);
				vec3 R = reflect(-L, N);
				float specular = pow( max(dot(R, E), 0.0), u_shininess);
				Is = u_specular_light * u_specular_material * specular; //add specular term*/
				vLightResult += Id + Is;
			}
			vLightResult.a = 1.0;
		}
		else
		{
			vLightResult = vec4(1.0, 1.0, 1.0, 1.0);
		}
		
		
    }
</script>
<script type="text/javascript">
	
    //Variáveis gerais
    var models = {};
    var gl;
    var canvas;
    
	//Variáveis de pista
	var squareVertexPositionBuffer; //quadrado
	
	//Variáveis de Jogo
	var players = [];
	var items = [];
	var projectiles = [];

    //Funções matemáticas
    function radToDeg(r) {
        return r * 180 / Math.PI;
    }

    function degToRad(d) {
        return d * Math.PI / 180;
    }
    
	function initPlayers(){ //To be defined at game select
		players.push(new Player(1,0,0,models.mario));
		players.push(new Player(3,0,0,models.bowser));
		players.push(new Player(5,0,0,models.peach));
		//players[0].setCollisionCircle(0,1,0,1);
	}
	function initObjects(){ //To be defined at game select
		players.push(new MovableObject(5,0,5,models.greenShell));
		players.push(new MovableObject(3,0,3,models.box));
		players[4].setScale(0.25);
		players[4].setCollisionRectangle(0,1,2,3);
		
	}
	function initTrack() { //To be defined at game select (even if it's just one...)
		squareVertexPositionBuffer = gl.createBuffer();
		gl.bindBuffer(gl.ARRAY_BUFFER, squareVertexPositionBuffer);
		vertices = [
			 100.0,  0.0,  100.0,
			-100.0,  0.0,  100.0,
			 100.0, 0.0,  -100.0,
			-100.0, 0.0,  -100.0
		];
		gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertices), gl.STATIC_DRAW);
		squareVertexPositionBuffer.itemSize = 3;
		squareVertexPositionBuffer.numItems = 4;
	}
	function init(meshes) {
        canvas = document.getElementById("Mairo-canvas");
        initGL(canvas);
        initShaders();
        initModels(meshes);
		initInput(document);
		initCamera();
		initPlayers();
		initObjects();
		initTrack();
        initTexture();
        initDrawingParameters();

        gameLoop();
    }

    function update() {
		//Camera 
		//Update Camera
		updateCamera();

		for(var i=0;i<players.length;i++)
        {
            //players[i].move();
        }
		for(var i=0;i<items.length;i++)
        {
            //items[i].move();
        }
		for(var i=0;i<projectiles.length;i++)
        {
            //projectiles[i].move();
        }
    }
    
    function gameLoop() {
		input();
        update();
        draw();
        requestAnimationFrame(gameLoop);
    }

    window.onload = function(){
        OBJ.downloadMeshes({
			'mario': 'models/Mario/mk_kart.obj',
			'peach': 'models/Peach/pk_kart.obj',
			'luigi': 'models/Luigi/luigi.obj',
			'bowser': 'models/Bowser/kk_kart.obj',
			'box': 'models/Caixa/qmark.obj',
			//'shell': 'models/Items/Shell3/KoopaShell.obj'
			//'shell': 'models/Items/Shell2/Green Shell/ItmGreenShell.obj'//almost works
			'greenShell': 'models/Items/GreenShell/GreenShell.obj'
			//'redShell': 'models/Items/RedShell/RedShell.obj'//almost works
			//'banana': 'models/Items/banana.obj'
    }, init);
}
</script>

</head>

<body>
        <h4>Kartellanister</h4>
        <div id="section">
              <canvas id="Mairo-canvas" style="border: none;" width="1280" height="720"></canvas>
        </div>
</body>
